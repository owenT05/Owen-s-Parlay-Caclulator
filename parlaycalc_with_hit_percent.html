<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>Parlay Calculator</title>
<meta content="#1a1a1a" name="theme-color"/>
<style>
    :root{--gap:12px;--radius:14px}
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;margin:0;background:#000;color:#fff;background:linear-gradient(180deg,#222,#1a1a1a);padding:10px 10px;border-bottom:1px solid #1e2442}
    h1{font-size:18px;margin:0}
    main{max-width:480px;margin:0 auto;display:flex;flex-direction:column;gap:10px;height:100dvh}
    .card{background:#2a2a2a;border:1px solid #232a4d;border-radius:var(--radius);padding:12px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .row{display:flex;gap:var(--gap);flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:120px}
    label{font-size:12px;color:#fff}
    input[type="number"],input[type="text"],select{background:#2e2e2e;border:1px solid #2a3569;color:#fff;border-radius:10px;padding:8px 10px;font-size:14px;width:100%}
    input[type="checkbox"]{width:20px;height:20px}
    button{appearance:none;border:none;background:#5a6cff;color:white;padding:8px 10px;border-radius:10px;font-weight:600;cursor:pointer;font-size:14px}
    button.secondary{background:#243069;color:#fff;border:1px solid #3b4aa0}
    table{width:100%;border-collapse:separate;border-spacing:0 8px;font-size:12px}
    th,td{text-align:left;padding:6px 8px}
    thead th{font-size:12px;color:#fff;font-weight:600}
    tbody tr{background:#333;border:1px solid #273176}
    tbody td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .pill{font-size:11px;padding:4px 8px;border-radius:999px;background:#444;color:#fff;border:1px solid #2a3a8b}
    .muted{color:#fff;opacity:.85}
    .results{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .stat{background:#333;border:1px solid #273176;border-radius:12px;padding:10px}
    .stat h3{margin:0 0 4px 0;font-size:11px;color:#fff;opacity:.9}
    .stat .val{font-size:16px;font-weight:700}
    footer{padding:8px 0 0;color:#fff;text-align:center;font-size:11px;opacity:.8}
    .del{background:#2b355f}
    .actions{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .hint{font-size:11px;color:#fff;margin:6px 0 0;opacity:.8}

    /* --- iPhone single-screen optimizations --- */
    @media (max-width: 430px) {
      main{max-width: 390px;gap:8px}
      body{padding:8px}
      h1{font-size:16px}
      .card{padding:10px}
      .results{grid-template-columns:repeat(2,minmax(0,1fr))}
      /* Hide non-essential columns to fit */
      thead th:nth-child(1), tbody td:nth-child(1){display:none} /* hide # */
      thead th:nth-child(4), tbody td:nth-child(4){display:none} /* hide per-leg Decimal */
      /* Make layout fixed-height to fit one view */
      html,body{height:100dvh;overflow:hidden}
      main{height:100%;}
      .section-wrap{display:flex;flex-direction:column;gap:8px;min-height:0;height:100%}
      .legs-wrap{flex:1;min-height:0;overflow:auto;border-radius:12px}
      .results{position:relative}
      /* Tighten controls */
      .field{min-width:110px}
      .hint,.tip-footer{display:none}
    }
  </style>
</head>
<body>
<main>
<section aria-label="Global settings" class="card">
<div class="row">
<div class="field" style="flex:1.1">
<label for="stake">Stake (USD $)</label>
<input id="stake" inputmode="decimal" min="0" step="0.01" type="number" value="100"/>
</div>
<div class="field" style="flex:1">
<label for="oddsType">Odds Type</label>
<select id="oddsType">
<option selected="" value="american">American (+150 / -120)</option>
<option value="decimal">Decimal (1.80 / 2.35)</option>
</select>
<div class="hint" id="formatHint">Enter odds like +150 or -120</div>
<div class="field" style="flex:1">
<label for="currency">Currency</label>
<select id="currency">
<option selected="" value="USD">USD — US Dollar</option>
<option value="EUR">EUR — Euro</option>
<option value="GBP">GBP — British Pound</option>
<option value="CAD">CAD — Canadian Dollar</option>
<option value="AUD">AUD — Australian Dollar</option>
<option value="JPY">JPY — Japanese Yen</option>
<option value="CHF">CHF — Swiss Franc</option>
<option value="MXN">MXN — Mexican Peso</option>
<option value="BRL">BRL — Brazilian Real</option>
<option value="ZAR">ZAR — South African Rand</option>
</select>
<div class="hint" id="rateHint">Rate: loading…</div>
</div>
</div>
<div class="field" style="flex:1;align-items:flex-start;justify-content:flex-end">
<label> </label>
<div class="actions">
<button aria-label="Add a new leg" id="addLeg">+ Add Leg</button>
<button aria-label="Clear all legs" class="secondary" id="clearAll">Clear</button>
</div>
</div>
</div>
<p class="muted tip-footer" style="margin:8px 2px 0">
        Use the dropdown to choose <strong>American</strong> or <strong>Decimal</strong> input. Toggle “Include” to skip a leg without deleting.
      </p>
</section>
<section class="section-wrap">
<section aria-label="Legs table" class="card legs-wrap">
<table aria-label="Parlay legs" role="table">
<thead>
<tr>
<th scope="col">#</th>
<th scope="col"><span id="oddsColHeader">Odds (American)</span></th>
<th scope="col">Include</th>
<th scope="col">Decimal</th>
<th scope="col">Implied Prob</th>
<th aria-hidden="true" scope="col"></th>
</tr>
</thead>
<tbody id="legs"></tbody>
</table>
<div class="row" style="margin-top:6px">
<span class="pill" id="legsCount">0 legs</span>
</div>
</section>
<section aria-label="Results" class="results">
<div class="stat"><h3>Total Decimal Odds</h3><div class="val" id="totalDec">—</div></div>
<div class="stat"><h3>Total American Odds</h3><div class="val" id="totalAm">—</div></div>
<div class="stat"><h3>Payout</h3><div class="val" id="payout">—</div><div class="hint" id="payoutFx"></div></div>
<div class="stat"><h3>Profit</h3><div class="val" id="profit">—</div><div class="hint" id="profitFx"></div></div>

<div class="stat"><h3>Chance Rating</h3><div class="val" id="chanceRating">—</div></div>
<div class="stat"><h3>Parlay Hit %</h3><div class="val" id="parlayHit">—</div></div>
</section>
</section>
<footer class="tip-footer">
      Tip: Add to Home Screen for 1‑tap access.
    </footer>
</main>
<script>
    // Elements
    const legsTbody   = document.getElementById('legs');
    const addLegBtn   = document.getElementById('addLeg');
    const clearAllBtn = document.getElementById('clearAll');
    const stakeEl     = document.getElementById('stake');
    const oddsTypeEl  = document.getElementById('oddsType');
    const oddsColHeader = document.getElementById('oddsColHeader');
    const formatHint  = document.getElementById('formatHint');

    const totalDecEl  = document.getElementById('totalDec');
    const totalAmEl   = document.getElementById('totalAm');
    const payoutEl    = document.getElementById('payout');
    const profitEl    = document.getElementById('profit');
    // Conversions
    // === FX: USD -> selected currency (Frankfurter API, ECB rates) ===
    const currencyEl = document.getElementById('currency');
    const rateHintEl = document.getElementById('rateHint');
    const payoutFxEl = document.getElementById('payoutFx');
    const profitFxEl = document.getElementById('profitFx');

    // Map currency codes to symbols and update Stake label
    const currencySymbols = {
      USD: '$', EUR: '€', GBP: '£', CAD: '$', AUD: '$', JPY: '¥', CHF: '₣', MXN: '$', BRL: 'R$', ZAR: 'R'
    };

    function updateStakeLabel() {
      const code = currencyEl.value || 'USD';
      const symbol = currencySymbols[code] || code;
      const stakeLabel = document.querySelector('label[for="stake"]');
      if (stakeLabel) stakeLabel.textContent = `Stake (${code} ${symbol})`;
    }


    let fxRates = null; // { rates: {EUR: 0.93, ...}, date: "YYYY-MM-DD" }

    async function loadFxRates() {
      try {
        // Cache in localStorage for the day to avoid repeated fetches
        const cacheKey = 'parlay_calc_fx_USD';
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
          const obj = JSON.parse(cached);
          // Keep cached if it's from today
          const today = new Date().toISOString().slice(0,10);
          if (obj && obj.date === today) {
            fxRates = obj;
          }
        }
        if (!fxRates) {
          const res = await fetch('https://api.frankfurter.app/latest?from=USD');
          if (!res.ok) throw new Error('Rate fetch failed');
          const data = await res.json();
          // Normalize: Frankfurter returns {amount, base, date, rates:{}}
          fxRates = { rates: data.rates || {}, date: data.date || new Date().toISOString().slice(0,10) };
          const today = new Date().toISOString().slice(0,10);
          localStorage.setItem(cacheKey, JSON.stringify({ ...fxRates, date: today }));
        }
        updateRateHint();
      } catch (e) {
        rateHintEl.textContent = 'Rate: unavailable';
      }
    }

    function fmtMoney(amount, code='USD') {
      if (!isFinite(amount)) return '—';
      try {
        return new Intl.NumberFormat(undefined, { style: 'currency', currency: code, maximumFractionDigits: 2 }).format(amount);
      } catch {
        // fallback
        return amount.toFixed(2) + ' ' + code;
      }
    }

    function usdToSelected(amountUsd) {
      const code = currencyEl.value || 'USD';
      if (!isFinite(amountUsd)) return NaN;
      if (code === 'USD') return amountUsd;
      if (!fxRates || !fxRates.rates || !fxRates.rates[code]) return NaN;
      return amountUsd * fxRates.rates[code];
    }

    function updateRateHint() {
      const code = currencyEl.value || 'USD';
      if (code === 'USD') {
        rateHintEl.textContent = '1 USD = 1.00 USD';
        return;
      }
      if (!fxRates || !fxRates.rates || !fxRates.rates[code]) {
        rateHintEl.textContent = 'Rate: unavailable';
        return;
      }
      const r = fxRates.rates[code];
      rateHintEl.textContent = `1 USD = ${r.toFixed(4)} ${code}`;
    }

    function amToDec(am){
      if (Number.isNaN(am) || am === 0) return NaN;
      return am > 0 ? 1 + am/100 : 1 + 100/Math.abs(am);
    }
    function impliedProbFromAm(am){
      if (Number.isNaN(am) || am === 0) return NaN;
      // Return percentage (0-100), not decimal (0-1)
      return am > 0 ? (10000/(am+100)) : (Math.abs(am)*100/(Math.abs(am)+100));
    }
    function decToAm(dec){
      if (!isFinite(dec) || dec <= 1) return NaN;
      return dec >= 2 ? (dec-1)*100 : -100/(dec-1);
    }

    // Formatting
    function formatNum(n, dp=2){
      if (!isFinite(n)) return '—';
      return Number(n).toLocaleString(undefined,{minimumFractionDigits:dp, maximumFractionDigits:dp});
    }

    // Core update
    function update(){
      const rows = [...legsTbody.querySelectorAll('tr')];
      const oddsType = oddsTypeEl.value; // 'american' or 'decimal'
      let productDec = 1;
      let productProb = 1;
      let includedCount = 0;
      let validProbCount = 0;

      rows.forEach(row => {
        const oddsEl  = row.querySelector('.odds');
        const includeEl = row.querySelector('.include');
        const decEl   = row.querySelector('.dec');
        const probEl  = row.querySelector('.prob');
        const include = includeEl.checked;
        const raw = parseFloat(oddsEl.value);

        // Derive per-leg decimal & implied prob based on global odds type
        let dec = NaN, probPct = NaN;
        if (oddsType === 'american'){
          dec = amToDec(raw);
          probPct = impliedProbFromAm(raw);
        } else {
          // Decimal input must be > 1 to be valid odds
          dec = (isFinite(raw) && raw > 1) ? raw : NaN;
          probPct = isFinite(dec) ? (100/dec) : NaN;
        }

        decEl.textContent  = isFinite(dec) ? formatNum(dec, 3) : '—';
        probEl.textContent = isFinite(probPct) ? formatNum(probPct, 2) + '%' : '—';

        if (include && isFinite(dec))  { productDec *= dec; includedCount++; }
        if (include && isFinite(probPct)) { productProb *= (probPct/100); validProbCount++; }
      });

      const stake = parseFloat(stakeEl.value) || 0;
      const payout = stake * productDec;
      const profit = payout - stake;
      const breakeven = 100 / productDec; // %
      const totalAm = decToAm(productDec);

      totalDecEl.textContent = productDec === 1 ? '—' : formatNum(productDec, 3);
      totalAmEl.textContent  = isFinite(totalAm) ? (totalAm>=0?'+':'') + formatNum(totalAm, 0) : '—';
      payoutEl.textContent   = productDec === 1 ? '—' : formatNum(payout, 2);
      profitEl.textContent  = productDec === 1 ? '—' : formatNum(profit, 2);
// FX display
      if (productDec === 1) {
        payoutFxEl.textContent = '';
        profitFxEl.textContent = '';
      } else {
        const code = currencyEl.value || 'USD';
        const payoutFx = usdToSelected(payout);
        const profitFx = usdToSelected(profit);
        if (isFinite(payoutFx) && isFinite(profitFx)) {
          const label = code === 'USD' ? 'USD' : code;
          payoutFxEl.textContent = '≈ ' + fmtMoney(payoutFx, label);
          profitFxEl.textContent = '≈ ' + fmtMoney(profitFx, label);
        } else {
          payoutFxEl.textContent = '';
          profitFxEl.textContent = '';
        }
      }

      // Chance Rating calculation
      const ratingEl = document.getElementById('chanceRating');
      const parlayHitEl = document.getElementById('parlayHit');
      if (includedCount>0 && validProbCount>0) {
        const chanceValue = productProb * 100;
        let ratingText = '—';
        let ratingColor = '#ffffff';
        if (chanceValue > 60) {
          ratingText = 'High chance';
          ratingColor = 'green';
        } else if (chanceValue >= 35) {
          ratingText = 'Medium chance';
          ratingColor = 'lightgreen';
        } else if (chanceValue >= 15) {
          ratingText = 'Low chance';
          ratingColor = 'yellow';
        } else {
          ratingText = 'Very low chance';
          ratingColor = 'red';
        }
        ratingEl.textContent = ratingText;
        ratingEl.style.color = ratingColor;
        parlayHitEl.textContent = formatNum(chanceValue, 2) + '%';
      } else {
        ratingEl.textContent = '—';
        ratingEl.style.color = '#ffffff';
        parlayHitEl.textContent = '—';
      }

      document.getElementById('legsCount').textContent = rows.length + (rows.length===1?' leg':' legs');
      persist();
    }

    // UI helpers
    function setOddsTypeUI(){
      const type = oddsTypeEl.value;
      oddsColHeader.textContent = type === 'american' ? 'Odds (American)' : 'Odds (Decimal)';
      formatHint.textContent = type === 'american'
        ? 'Enter odds like +150 or -120'
        : 'Enter odds like 1.80 or 2.35 (must be > 1.00)';
      update();
    }

    function persist(){
      const data = {
        stake: stakeEl.value,
        oddsType: oddsTypeEl.value,
        legs: [...legsTbody.querySelectorAll('tr')].map(tr => ({
          v: tr.querySelector('.odds').value,
          inc: tr.querySelector('.include').checked
        }))
      };
      try { localStorage.setItem('parlay_calc_v3', JSON.stringify(data)); } catch {}
    }
    function restore(){
      // Prefer v3 data, fall back to v2
      const raw = localStorage.getItem('parlay_calc_v3') || localStorage.getItem('parlay_calc_v2');
      const isSmall = window.matchMedia('(max-width: 430px)').matches;
      if (!raw) {
        // Fewer default rows on iPhone to ensure one-screen fit
        addLeg();
        if (!isSmall) addLeg(); else addLeg('');
        return;
      }
      try{
        const data = JSON.parse(raw);
        stakeEl.value = data.stake ?? 100;
        oddsTypeEl.value = data.oddsType ?? 'american';
        legsTbody.innerHTML = '';
        (data.legs ?? []).forEach(item => addLeg(item.v, item.inc));
        if ((data.legs ?? []).length === 0){ addLeg(); }
      }catch{
        addLeg();
      }
      setOddsTypeUI();
      update();
    }

    function addLeg(value = '', include = true){
      const idx = legsTbody.children.length + 1;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="muted">${idx}</td>
        <td><input class="odds" type="text" step="0.01" placeholder="Enter odds" value="${value}" inputmode="text" autocapitalize="off" autocorrect="off" spellcheck="false" /></td>
        <td style="text-align:center"><input class="include" type="checkbox" ${include? 'checked':''} aria-label="Include leg ${idx}" /></td>
        <td class="dec">—</td>
        <td class="prob">—</td>
        <td style="text-align:right"><button class="del" title="Delete leg ${idx}" aria-label="Delete leg ${idx}">Delete</button></td>
      `;
      legsTbody.appendChild(tr);
      wireRow(tr);
      update();
    }

    function renumber(){
      [...legsTbody.querySelectorAll('tr')].forEach((tr,i)=>{
        tr.querySelector('td').textContent = i+1;
      });
    }

    function wireRow(tr){
      tr.querySelector('.odds').addEventListener('input', update);
      tr.querySelector('.include').addEventListener('change', update);
      tr.querySelector('.del').addEventListener('click', () => {
        tr.remove();
        renumber();
        update();
      });
    }

    // Events
    addLegBtn.addEventListener('click', () => addLeg());
    clearAllBtn.addEventListener('click', () => {
      if (!confirm('Clear all legs?')) return;
      legsTbody.innerHTML = '';
      update();
    });
    stakeEl.addEventListener('input', update);
    oddsTypeEl.addEventListener('change', setOddsTypeUI);
    currencyEl.addEventListener('change', ()=>{ updateRateHint(); updateStakeLabel(); update(); });
// Boot
    restore();
    updateStakeLabel();
    loadFxRates();
</script>
</body>
</html>
